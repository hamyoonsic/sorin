
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        sorinAccount.name += '님';

var subscriberURI = '/selectHeaderTimeSet';
var subscriberStartLmeURI = '/startLmeData';
var subscriberRestTimeURI = '/setRestTime';
var subscriberSpreadURI = '/spread';

let headerRestDeFixed = "N";  // 고정가 운영 여부
let headerRestDeLive = "N";   // 실시간가 운영 여부
let headerRestdeAt = "N";       // 영업시간 여부
let headerSideCarMetalCode ="7"; //사이드카 발동 금속 코드
let headerMotnAt ="N";          //사이드카

let headerRestWaitNm = "영업 시작까지"; // 소켓 타이머 문구 초기값
let headerRestWaitTerm = 0; // 소켓 시간차 초기값
let headerOpenTimeCode = "00"; //개장시간 범위 코드
let chartStTitleNm = ""; //차트 상단 시작문구
let chartEdTitleNm = ""; //차트 상단 끝 문구

let restDataList = [];

var headerRestTimer = null;  // 영업 시간 타이머 interval
var resultTime =""; // 영업 시간 DD일 HH:mm:ss

let frstPrcFlag = new Array(); //시초가 수신여부
let operateFlag = false; //운영여부

function websocketHeaderSubscriber(){
    stompSubscribe(stompClient, subscriberURI, function(receiveData) {
        if(!sorin.validation.isNull(receiveData.body)){
            const data = JSON.parse(receiveData.body);
            let restDtTime = data.restDtTime;
            restDataList = data.restDtTime; // 금속별 문구 처리를 위한 전역변수 세팅
            
            headerRestWaitTerm =  restDtTime[0].topWaitTerm; // 상단 시간차
            headerRestWaitNm = restDtTime[0].topWaitNm; // 소켓 타이머 문구
            for (var i = 0; i < restDtTime.length; i++) {
                if(restDtTime[i].metalCode == '7'){
//                     headerRestWaitNm = restDtTime[i].topWaitNm; // 소켓 타이머 문구
//                     headerRestWaitTerm = restDtTime[i].restWaitTerm; // 소켓 시간차
                    headerOpenTimeCode = restDtTime[i].openTimeCode; //개장시간 범위 코드
                    chartStTitleNm = restDtTime[i].chartStTitle;
                    chartEdTitleNm = restDtTime[i].chartEdTitle;
                }
            }
            setRestDtTime();    // 타이머 문구 세팅, interval 시작
        }
    });

    stompSubscribe(stompClient, subscriberStartLmeURI, function(receiveData) {
    	console.log(receiveData.body);
        if(!sorin.validation.isEmpty(receiveData.body) && receiveData.body.includes("startLmeData")){
            if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
            	var metalCode = $(".chart-tab-area > button.active").parents().siblings(".table-list-area").children(".table-list-tbody:visible").find('input[name=metalCode]').val();
            	if(receiveData.body.includes(metalCode)) { //현재 보고있는 금속인 경우에만 refresh
	                $(".sorin-state").removeClass("show");  //리플레시 작동 안할 시 대비
	                location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
            	}
            } else {
                headerRestInfo();   // 휴일, 실시간 고정가 영업 여부
                getRestDtTimeSet(); // 영업 시간 타이머
            }
        }
    });

    stompSubscribe(stompClient, subscriberRestTimeURI, function(receiveData) {
        if(!sorin.validation.isEmpty(receiveData.body) && receiveData.body == "setRestTime"){
            if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
                $(".sorin-state").removeClass("show");  //리플레시 작동 안할 시 대비
                location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
            } else {
                headerRestInfo();   // 휴일, 실시간 고정가 영업 여부
                getRestDtTimeSet(); // 영업 시간 타이머
            }
        }
    });
    
    stompSubscribe(stompClient, subscriberSpreadURI, function(receiveData) {
        if(!sorin.validation.isEmpty(receiveData.body) && receiveData.body == "notMatchedSpread"){
            if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
                $(".sorin-state").removeClass("show");  //리플레시 작동 안할 시 대비
                location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
            } else {
                headerRestInfo();   // 휴일, 실시간 고정가 영업 여부
                getRestDtTimeSet(); // 영업 시간 타이머
            }
        }
    });
}

function websocketHeaderOpenLoop() {
    setTimeout(function() {
        if(stompClient.connected == true) {
            websocketHeaderSubscriber();
            webSocketSidcarOP();
        } else {
            websocketHeaderOpenLoop();
        }
    }, 100);
}

function headerRestInfo() { // 휴일, 실시간 고정가 영업 여부
    sorin.ajax.postSetDataType('/main/headerRestInfo', '', '', false,function(data){
        if(!sorin.validation.isNull(data)){
            headerRestDeFixed = data.restDeFixed;
            headerRestDeLive = data.restDeLive;
            headerRestdeAt = data.restdeAt;
        }
    });
}

function getRestDtTimeSet() { // 영업 시간 타이머 최초값
    sorin.ajax.postSetDataType('/main/restDtTimeSet', '', '', false,function(data){
        var restDtTime = "";
        if(!sorin.validation.isNull(data)){
            restDtTime = data.restDtTime;
            restDataList = data.restDtTime; // 금속별 문구 처리를 위한 전역변수 세팅
            
            headerRestWaitTerm =  restDtTime[0].topWaitTerm; // 상단 시간차
            headerRestWaitNm = restDtTime[0].topWaitNm; // 소켓 타이머 문구
            for (var i = 0; i < restDtTime.length; i++) {
                if(restDtTime[i].metalCode == pageMetal){
//                     headerRestWaitNm = restDtTime[i].topWaitNm; // 소켓 타이머 문구
//                     headerRestWaitTerm = restDtTime[i].restWaitTerm; // 소켓 시간차
                    headerOpenTimeCode = restDtTime[i].openTimeCode; //개장시간 범위 코드
                    chartStTitleNm = restDtTime[i].chartStTitle;
                    chartEdTitleNm = restDtTime[i].chartEdTitle;
                }
            }
            setRestDtTime();    // 타이머 문구 세팅, interval 시작
        }
    });
}


function setRestDtTime() { // 타이머 문구 세팅, interval 시작
    $("#timeset-span").text("서린닷컴 "+headerRestWaitNm); // 타이머 문구 변경
    startHeaderRestTimer(headerRestWaitTerm); // 영업 시간 타이머 interval
}

function startHeaderRestTimer(secondTerm) { // 영업 시간 타이머 interval

	clearInterval(headerRestTimer); // 타이머 clear
	headerRestTimer = setInterval(function() {
		resultTime = sorin.timer.timeFormat(secondTerm); // 시간 DD일 HH:mm:ss format으로 변경
		for (var i = 0; i < restDataList.length; i++) {
 		try{
			if(pageMetal == restDataList[i].metalCode){
					if(restDataList[i].openTimeCode == "00" || restDataList[i].openTimeCode == "10" || restDataList[i].openTimeCode == "30"){ // 휴일
						if(secondTerm <= 0){ // 시간차가 0이 들어왔을 때
							stopHeaderRestTimer(); // interval clear
							
							$("#headerTimeset").text('');
							$(".sum-title").empty();
							$(".sum-title").html('서린닷컴 시초가 수신전입니다.');
							$(".rChart-sum").removeClass("sum-type1");
							$(".rChart-sum").removeClass("sum-type2");
							$(".rChart-sum").addClass("sum-type3");
							$(".chart-sum-title").show();
							headerRestInfo(); // 휴일, 실시간 고정가 영업 여부
							getRestDtTimeSet();// 영업 시간 타이머
							
							return;
						} else {
							if(restDataList[i].openTimeCode == "00"){
								$(".sum-title").empty();
								$(".sum-title").html(restDataList[i].chartStTitle + " " + restDataList[i].chartEdTitle);
								$(".rChart-sum").removeClass("sum-type1");
								$(".rChart-sum").removeClass("sum-type2");
								$(".rChart-sum").addClass("sum-type3");
								$(".chart-sum-title").show();
							} else {
								$(".sum-title").empty();
								$(".sum-title").html(restDataList[i].chartStTitle + " <span class='off-time'>-"+sorin.timer.timeFormat(restDataList[i].restWaitTerm)+"</span> "+ restDataList[i].chartEdTitle);
								$(".rChart-sum").removeClass("sum-type1");
								$(".rChart-sum").removeClass("sum-type2");
								$(".rChart-sum").addClass("sum-type3");
								$(".chart-sum-title").show();
							}
						}
					} else if(restDataList[i].openTimeCode == "20" || restDataList[i].openTimeCode == "21" || restDataList[i].openTimeCode == "23"){ // 운영중
						if(secondTerm <= 0){ // 시간차가 0이 들어왔을 때
							stopHeaderRestTimer(); // interval clear
							
							if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
		 						location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
								return;
							} else{
								$(".sum-title").empty();
								$(".sum-title").html(restDataList[i].chartStTitle + " " + restDataList[i].chartEdTitle);
								$(".rChart-sum").removeClass("sum-type2");
								$(".rChart-sum").removeClass("sum-type3");
								$(".rChart-sum").addClass("sum-type1");
								$(".chart-sum-title").hide();
								headerRestInfo(); // 휴일, 실시간 고정가 영업 여부
								getRestDtTimeSet();// 영업 시간 타이머
							}

							return;
						}
						operateFlag = true;
						
					} else if(restDataList[i].openTimeCode == "22" || restDataList[i].openTimeCode == "24" || restDataList[i].openTimeCode == "25"){ // 일시휴장,사이드카
						if(restDataList[i].openTimeCode == "24" || restDataList[i].openTimeCode == "25"){ // 사이드카
							var headerSleMthdCode = $(".table-list-tbody:visible").find('input[name=sleMthdCode]').val();
							if(headerSleMthdCode == "01"){
								
								if(restDataList[i].restWaitTerm <= 0){ // 시간차가 0이 들어왔을 때
									$(".sum-title").empty();
									$(".sum-title").html(restDataList[i].chartStTitle + " " + restDataList[i].chartEdTitle);
									$(".rChart-sum").removeClass("sum-type2");
									$(".rChart-sum").removeClass("sum-type3");
									$(".rChart-sum").addClass("sum-type1");
									$(".chart-sum-title").hide();									
// 									stopHeaderRestTimer(); // interval clear
									
// 									if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
// 										location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
// 										return;
// 									} else {
// 										headerRestInfo(); // 휴일, 실시간 고정가 영업 여부
// 										getRestDtTimeSet();// 영업 시간 타이머
// 									}
								} else {
									$(".sum-title").empty();
									$(".sum-title").html(restDataList[i].chartStTitle + " <span class='off-time'>-"+sorin.timer.timeFormat(restDataList[i].restWaitTerm)+"</span> "+restDataList[i].chartEdTitle);
									$(".rChart-sum").removeClass("sum-type1");
									$(".rChart-sum").removeClass("sum-type3");
									$(".rChart-sum").addClass("sum-type2");
									$(".chart-sum-title").show();
								}	
							} else if (headerSleMthdCode == "02"){
								$(".sum-title").empty();
								$(".sum-title").html(restDataList[i].chartStTitle + " " + restDataList[i].chartEdTitle);
								$(".rChart-sum").removeClass("sum-type2");
								$(".rChart-sum").removeClass("sum-type3");
								$(".rChart-sum").addClass("sum-type1");
								$(".chart-sum-title").hide();
							}
						} else if (restDataList[i].openTimeCode == "22"){ // 일시휴장
							if(restDataList[i].restWaitTerm <= 0){ // 시간차가 0이 들어왔을 때
								stopHeaderRestTimer(); // interval clear
								
								if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
									location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
									return;
								} else {
									headerRestInfo(); // 휴일, 실시간 고정가 영업 여부
									getRestDtTimeSet();// 영업 시간 타이머
								}
							} else {
								$(".sum-title").empty();
								$(".sum-title").html(restDataList[i].chartStTitle + " <span class='off-time'>-"+sorin.timer.timeFormat(restDataList[i].restWaitTerm)+"</span> "+restDataList[i].chartEdTitle);
								$(".rChart-sum").removeClass("sum-type1");
								$(".rChart-sum").removeClass("sum-type3");
								$(".rChart-sum").addClass("sum-type2");
								$(".chart-sum-title").show();
							}	
						}
						
					} else if (restDataList[i].openTimeCode == "40" || restDataList[i].openTimeCode == "41") {// 시초가 수신
						stopHeaderRestTimer(); // interval clear
						
						$("#headerTimeset").text('');
						$(".sum-title").empty();
						$(".sum-title").html(restDataList[i].chartStTitle  + " " + restDataList[i].chartEdTitle);
						$(".rChart-sum").removeClass("sum-type1");
						$(".rChart-sum").removeClass("sum-type2");
						$(".rChart-sum").addClass("sum-type3");
						$(".chart-sum-title").show();
						
						return;
					} else {
						if(secondTerm <= 0){ // 시간차가 0이 들어왔을 때
							stopHeaderRestTimer(); // interval clear
							
							if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
								location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
							} else{
								headerRestInfo(); // 휴일, 실시간 고정가 영업 여부
								getRestDtTimeSet();// 영업 시간 타이머
							}

							return;
						}
					}
					$("#headerTimeset").text(resultTime);
					restDataList[i].restWaitTerm = restDataList[i].restWaitTerm-1;
					secondTerm=secondTerm-1;
					
					if(headerRestdeAt == "Y"){ //휴일일 때
						//메인화면 타이머
						if($(".off-time").is(":visible")){
							$(".off-time:visible").text("-"+resultTime);
						}
					}
					
				} else {
					restDataList[i].restWaitTerm = restDataList[i].restWaitTerm-1;
				} 
 		} catch(err) {
				stopHeaderRestTimer();
				alertPopup("타이머에 문제가 생겼습니다.\n확인을 누르면 메인화면으로 갑니다.", function() {
					location.reload(true);
					return true;
				});
			}
		}
	},1000);
}

function stopHeaderRestTimer(){ // 타이머 0일 때, 화면 refresh
    clearInterval(headerRestTimer); // 타이머 clear
    headerRestTimer = null;
}


var alRestdeStatus = "N"; // 알루미늄 휴무
var znRestdeStatus = "N"; // 아연 휴무
var pageMetal = "7";

// 사이트카 웹소켓 (발동,발동 해제시에만 들어옴)
function webSocketSidcarOP(){
    stompSubscribe(stompClient, "/sidecar", function(receiveData) {
        if(!sorin.validation.isNull(receiveData.body)){
            if(!sorin.validation.isEmpty(sorinAccount)){ // 로그인 여부 체크
                const data = JSON.parse(receiveData.body);
                for (var i = 0; i < data.length; i++) {
                    var sidecarData = data[i];
                    if(pageMetal == '7'){
                        if(sidecarData.metalCode == '7' && sidecarData.motnAt == 'Y'){
                            // 알루미늄 사이드카 걸렸을 경우
                              alRestdeStatus = "Y";
        				} else {
       						  alRestdeStatus = "N";
                        }
                    	headerSideCarMetalCode = sidecarData.metalCode; // 사이드카 메탈코드
                        headerMotnAt = sidecarData.motnAt; // 사이드카 발동 여부

                        if(currentPage == "main" || currentPage == "/pd/itemPriceSearch"){
//    							location.reload(true); //현재 페이지가 메인, 금속 메뉴일 경우 refresh
						}
                      }
                    }
                }
            }
    });
}



// authMetalMenu(state)
// 	state = 1~4 :  임시회원, 계좌 상태별 팝업
//  state = 5 :  간편회원, 메뉴 접근 불가 팝업
	
function switchHeaderType() {
	
	//console.log(sorinAccount);
    switch(sorinAccount.type) {
     case '01':
     /*    if('01' != sorinAccount.mberSttusCode){
            // 커뮤니티 메뉴, 마이페이지, 알림 설정, 배송 조회, 장바구니, ewallet 접근 불가
            //마이페이지 접근시 정회원 전용 팝업알림 제거 
            //noAuthCmmntyMenu(); // 임시 회원
            authMetalMenu();  // 임시 회원  (금속 메뉴 접근 불가)
        } */

        if('' == sorinAccount.secode  || '04' == sorinAccount.secode ){
            authMetalMenu('5'); // 04-자금담당 (금속 메뉴 접근 불가)
        }

         $('#simplelogin-header').hide();
         $('#logout-header').hide();
         $('#login-header .username').html(sorinAccount.name);
         //$('#login-header .useremail').html(sorinAccount.email);
         
         //신규로 변경예정
          /*
         if(sorinAccount.refndAcnutSttusCode == '02' || sorinAccount.refndAcnutSttusCode == '04') {
            $('#login-header .refndSttus').html("시스템 오류입니다.<br>고객센터로 문의해 주세요.");
         } else if(sorinAccount.refndAcnutSttusCode == '03') {
        	$('#login-header .refndSttus').html("하나은행 에스크로 선불금 관리대행<br>서비스의 동의가 필요합니다. <a href='https://biz.kebhana.com/esc/escn/index.do?menuItemId=wcesc800_100i' target='_blank'>동의하러가기</a>");
        	//$('#login-header .refndSttus').html("<a href='https://biz.kebhana.com/esc/escn/index.do?menuItemId=wcesc800_100i' target='_blank'><button type='button' class='btn-header-agreAt'>동의하러가기</button></a>");
         } else if(sorinAccount.refndAcnutSttusCode == '') {
        	//관리자가 사용등록(7350)을 안한 상태
            $('#login-header .refndSttus').html("관리자 승인 대기중입니다.");
         } else if(sorinAccount.mberSttusCode == '03' && sorinAccount.refndAcnutSttusCode == '05') {
        	//임시회원상태이고 환불계좌상태가 최종응답완료일 경우
            $('#login-header .refndSttus').html("관리자 승인 대기중입니다.");
         } else {
        	$('#login-header .refndSttus').html("");
         }
			*/
          //CSS SHOW display 설정
          let mberSttusCode  = sorinAccount.mberSttusCode;
          let refndAcnutSttusCode =  sorinAccount.refndAcnutSttusCode;
          
          
          //아래 소스코드 개선작업
          mberPopupChange (mberSttusCode, refndAcnutSttusCode);
          
          //임시회원 계좌상태별 팝업
          if(mberSttusCode == '03' && refndAcnutSttusCode == '') {				//임시회원
        	  authMetalMenu('1');			//하나은행 계좌 등록 중입니다.
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '01') {		//임시회원&환불계좌전송완료
        	  authMetalMenu('2');			//고객 전용 가상 계좌 준비중입니다. 
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '03') {		//임시회원&응답완료
        	  authMetalMenu('3');			//선불금 관리대행 서비스 동의를 진행 중입니다.
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '05') {		//임시회원&최종응답완료
        	  authMetalMenu('4');			//거래회원 승인 대기 중 입니다.
          } else {
        	 	//$('#login-header .refndSttus').html("");
          }
          
          /*
          if(mberSttusCode == '03' && refndAcnutSttusCode == '') {
           	//#1 기업 회원 (환불계좌 X ,가상계좌 X, 에스크로 X, 회원승인 X )
           	
           	 $('#memberState1').css('display', 'block');
        	 $('#memberState2').css('display', 'none');
        	 $('#memberState3').css('display', 'none');
        	 $('#memberState4').css('display', 'none');
        	 $('#memberState5').css('display', 'none');
			
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '01') {
        	//#2 기업 임시회원 (환불계좌 O ,가상계좌 X, 에스크로 X, 회원승인 X )  

         	 $('#memberState1').css('display', 'none');
        	 $('#memberState2').css('display', 'block');
        	 $('#memberState3').css('display', 'none');
        	 $('#memberState4').css('display', 'none');
        	 $('#memberState5').css('display', 'none');
        	
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '03') {
          	//#3 기업 임시회원 (환불계좌 O ,가상계좌 O, 에스크로 X, 회원승인 X ) 

         	 $('#memberState1').css('display', 'none');
        	 $('#memberState2').css('display', 'none');
        	 $('#memberState3').css('display', 'block');
        	 $('#memberState4').css('display', 'none');
        	 $('#memberState5').css('display', 'none');
          	
          } else if(mberSttusCode == '03' && refndAcnutSttusCode == '05') {
          	//#4 기업 임시회원 (환불계좌 O ,가상계좌 O, 에스크로 O, 회원승인 X )

         	 $('#memberState1').css('display', 'none');
        	 $('#memberState2').css('display', 'none');
        	 $('#memberState3').css('display', 'none');
        	 $('#memberState4').css('display', 'block');
        	 $('#memberState5').css('display', 'none');  
          	
          } else if(mberSttusCode == '01') {
          	//#5 기업 정회원 (환불계좌 O ,가상계좌 O, 에스크로 O, 회원승인 O )  

         	 $('#memberState1').css('display', 'none');
        	 $('#memberState2').css('display', 'none');
        	 $('#memberState3').css('display', 'none');
        	 $('#memberState4').css('display', 'none');
    		 $('#memberState5').css('display', 'block');
        	 
        	 //최근접속일자 >= 최종승인일자 가입완료팝업 표기 X
        	 var headUtil = $('.util-list > ul'); 
        	 if(sorinAccount.currentDt > sorinAccount.mberConfmProcessDt){

        		 headUtil.removeClass('member-pop-on');
        	 } else {
        		 headUtil.addClass('member-pop-on');
        	 }
        	
          } else {
        	$('#login-header .refndSttus').html("");
          }*/
         
         $('#login-header').show();
         break;
     case '02':
         authMetalMenu('5');  // 간편 회원 (금속 메뉴 접근 불가)
         noAuthCmmntyMenu(); // 간편 회원 (커뮤니티 조회, 마이페이지 x)
         $('#logout-header').hide();
         $('#login-header').hide();
         $('#simplelogin-header .username').html(sorinAccount.name);
         $('#simplelogin-header .useremail').html(sorinAccount.email);
         $('#simplelogin-header').show();
         break;
     default:
         $('#simplelogin-header').hide();
         $('#login-header').hide();
         $('#logout-header').show();
 }
}


//회원구분별 CSS 뿌려주기
function mberPopupChange (mberSttusCode, refndAcnutSttusCode) {	
	if(mberSttusCode == '03'){		
		for (var i = 1; i < 6; i++){			
			let setDisplay = 'none';			
			if(refndAcnutSttusCode == "" && i == 1){
				setDisplay = 'block';
			} else if (refndAcnutSttusCode == "01" && i == 2){
				setDisplay = 'block';
			} else if (refndAcnutSttusCode == "03" && i == 3){
				setDisplay = 'block';
			} else if (refndAcnutSttusCode == "05" && i == 4){
				setDisplay = 'block';
			} else {				
			}
			$('#memberState'+i).css('display', setDisplay);		  	 	 
		}		
	} else {		
		if(mberSttusCode == '01'){			
			for (var i = 1; i<6; i++){				
				let setDisplay = 'none';				
				 if (refndAcnutSttusCode == "05" && i == 5){
				 	setDisplay = 'block';
				 } else {
				 }
			  	 $('#memberState'+i).css('display', setDisplay);
			}

       	 	 //최근접속일자 >= 최종승인일자 가입완료팝업 표기 X
	       	 var headUtil = $('.util-list > ul'); 
	    	 if(sorinAccount.currentDt > sorinAccount.mberConfmProcessDt){	
	    		 headUtil.removeClass('member-pop-on');
	    	 } else {
	    		 headUtil.addClass('member-pop-on');
	    	 }
		} else {
		  	$('#login-header .refndSttus').html("");	
		}	
	}		
}


// 배송중 건수
function orderDlvyIng() {
    sorin.ajax.getSetDataType('/main/dlvyIngCnt', '', '', false, function(data) {
        if (!sorin.validation.isEmpty(data) && data != '0') {
            $('li.util-shipping .header-toggle-del span.cnt').text(data);
        }
    });
}


$(function() {
    websocketHeaderOpenLoop(); // 타이머 싱크를 위한 웹소켓

    headerRestInfo();   // 휴일, 실시간 고정가 영업 여부
    getRestDtTimeSet(); // 영업 시간 타이머
    setRestDtTime();    // 타이머 문구 세팅, interval 시작

/*  $(".pop-h1").html('팝업 제목 테스트123');
    sorin.ajax.postSetDataType('/main/popup', '', 'html', true, function(data) {
        $(".pop-con").html(data);
    }) */

    setHeaderMenu();    // 헤더 메뉴
    switchHeaderType(); // 회원 유형, 권한 별 헤더
    refreshHeader();    // ewallet, 공지사항
    hopePcAlarmList();  // 알람 내역

    orderDlvyIng();     // 배송중 건수
});

$(".btn-header-logout").click(function() {
    sorin.ajax.getSetDataType("/account/logout", "", "", true, function() {
    	moveToMain();
    });
});

/////////////////////////////////////////////////////////////////////////

$("#logout-header .util-member").click(function() {
    pageMove('/account/login','','','-1');
});

$("#logout-header .util-join").click(function() {
    pageMove('/fo/Member/selectEntrpsEtr', '', '', '-1');
    $('html > head > title').text('회원사 가입 신청 1단계 약관동의 | SORIN e-Commerce');
});

/////////////////////////////////////////////////////////////////////////

$("#simplelogin-header .btn-header-alarm, #simplelogin-header .btn-header-account").click(function() {
    alertPopup('기업회원 로그인 시 이용할 수 있는 서비스 입니다.', function(){return true;});
});

$("#simplelogin-header .util-member").click(function() {
	pageMove('/my/mypage/dashboard','','','-1');
});

$("#simplelogin-header .util-comember").click(function() {
    pageMove('/account/login','','','-1');
});

$("#simplelogin-header .util-join").click(function() {
    pageMove('/fo/Member/selectEntrpsEtr', '', '', '-1');
});

/////////////////////////////////////////////////////////////////////////


$("#login-header .util-member").click(function() {
    pageMove('/my/mypage/dashboard','','','-1');
});

$("#login-header .btn-all").click(function() {
    pageMove("/my/alarm/alarmList",'','','-1');
});

$("#login-header .btn-header-alarm").click(function() {
    pageMove("/my/alarm/alarmList",'','','-1');
});

$("#login-header .util-shipping").click(function() {
	pageMove('/my/order/recentOrderDtls', 'dlvying', 'application/json', '-1');
});

$("#login-header .util-cart").click(function() {
    pageMove('/pd/itemPriceBasket', JSON.stringify({"sleMthdCode":"01"}), 'application/json', '-1')
});

$("#login-header .btn-header-account").click(function() {
    pageMove("/fo/ewalletMng/selectRefndRequstDtls",'','','-1');
});

$('#login-header .member-ewallet').click(function(){
	pageMove('/fo/ewalletMng/selectRefndRequstDtls', '', '', '-1');
});

/* function noAuthMetalMenu() { // 금속 메뉴 접근 불가
    $("#headerNav .metalMenu").attr({
        'href' : 'javascript:;',
        'onclick':
        'javascript:alertPopup("상품을 주문할 권한이 없는 계정입니다.", function(){return true;});'
    });
} */


function authMetalMenu(state) { //회원 계좌상태별 팝업
	var message = "";
	
	if(state == '1') { 
		message = "하나은행 계좌 등록 중입니다.";
	} else if(state == '2') {
		message = "고객 전용 가상 계좌 준비중입니다.";
	} else if(state == '3') {
		message = "선불금 관리대행 서비스 동의를 진행 중입니다.";
	} else if(state == '4') {
		message = "거래회원 승인 대기 중 입니다.";
	} else if(state == '5') {
		message = "기업 회원만 상품을 주문할 수 있습니다.";
	}
	
	
	
    $("#headerNav .metalMenu").attr({
        'href' : 'javascript:;',
        'onclick':
        'javascript:alertPopup("'+message+'", function(){return true;});'
    });
}


function noAuthCmmntyMenu() {  // 커뮤니티 메뉴, 마이페이지, 알림 설정, 배송 조회, 장바구니, ewallet 접근 불가
        $("#login-header .util-alert").parent().children().not(".util-memberinfo").find("a").attr("href","javascript:alertPopup('정회원 전용 서비스입니다.', function(){return true;});");
        $("#login-header .btn-all").attr('onclick', '').unbind('click');
        $("#login-header .btn-header-alarm, #login-header #noticeAlert a").attr('onclick', 'javascript:alertPopup("정회원 전용 서비스입니다.", function(){return true;});').unbind('click');
        $("#login-header .btn-header-account").attr('onclick', 'javascript:alertPopup("정회원 전용 서비스입니다.", function(){return true;});').unbind('click');
}


function refreshHeader() { // ewallet, 공지사항
    if(sorinAccount.type == '01' || sorinAccount.type == '02') {
        sorin.ajax.getSetDataType('/main/eWalletAccount', {'entrpsNo': sorinAccount.entrpsNo}, '', false,
        function(data) {
            $('.eWalletAccount').html(data=='' ? 0 : data);
        });
    }

    sorin.ajax.getSetContentType("/main/topnotice", "", "", false, function(data) {
        for(var notice of data) {
            var li = $('<li><a href="javascript:;"><span>' + notice.noticeSj + '</span></a></li>');
            var param = '';
            li.attr('onclick', "pageMove('/fo/notice/noticeDtls',JSON.stringify({'noticeNo' : '"+ notice.noticeNo + "'}), 'application/json','csfaqcsfFaqViews')")

            $("#marquee-items").append(li);
        }
    });
    $('.eWalletAccount').unmask();
    sorin.mask.comma();
}


function hopePcAlarmList() { // 헤더 알림 내역
    if(sorinAccount.type == '01') {
        json = { 'entrpsNo': sorinAccount.entrpsNo };
        sorin.ajax.postSetDataType('/my/alarm/selectHeaderAlarm', JSON.stringify(json), '', false,
                function(data) {

                if(!sorin.validation.isNull(data)){

                    var li = "";
                    var alarmCount = data.headerAlarmList.length;

                    if(alarmCount > 0){
                        $('#login-header .btn-header-alarm').append('<span class="no">'+alarmCount+'</span>');
                    }
/*
                        $('#login-header .btn-header-alarm').on("mouseover",function(){ // 알림 내역 mouseover
                             $('#login-header #noticeAlert').addClass('active');
                        });

                        $('#login-header .util-alert').on("mouseleave",function(){ // 알림 내역 mouseleave
                             $('#login-header #noticeAlert').removeClass('active');
                        });
                    }else{
                        $("#login-header .btn-header-alarm").off('mouseover');
                    } */


                    $.each(data.headerAlarmList,function(index,obj){

                            var ntcnSndngComptde = obj.ntcnSndngComptde <= 0 ? 1 : obj.ntcnSndngComptde;
                            var contentLength = obj.hopepc.length;

                            var content = contentLength >= 13 ? obj.hopepc.substr(0,14)+"..." : obj.hopepc;

                            if(ntcnSndngComptde >= 60){
                                li += '<li> <dl class="data"><dt>'+obj.goodsNm+'<span class="blue">'+content+'</span></dt><dd>'+parseInt(ntcnSndngComptde/60)+'시간전</dd></dl></li>';
                            }

                            else {
                                li += '<li> <dl class="data"><dt>'+obj.goodsNm+'<span class="blue">'+content+'</span></dt><dd>'+ntcnSndngComptde+'분전</dd></dl></li>';
                            }

                    });

                    $("#login-header .util-alert ul").append(li);
                }
            });
    }
}


function setHeaderMenu(){ // 헤더 메뉴
    sorin.ajax.postSetDataType('/selectHeaderMenu','', '', false,
            function(data){
                if(!sorin.validation.isEmpty(data)){
                    var input ="";
                    for(var headerMenu of data.headerMenuList){
                        if(headerMenu.metalCode != null && headerMenu.sleMthdCode != null){
                        	let menuIdParams = makeMenuActiveIdenty(headerMenu.menuUrl, JSON.stringify({metalCode : headerMenu.metalCode , sleMthdCode : headerMenu.sleMthdCode}));
                        	
                            input += '<li>';
                            input += '<a href="javascript:pageMove(\''+headerMenu.menuUrl+'\', JSON.stringify({metalCode : \''+headerMenu.metalCode+'\', sleMthdCode : \''+headerMenu.sleMthdCode+'\' }), \''+"application/json"+'\', \'' + menuIdParams + '\');" class="metalMenu" id="headerMenuOrder' + menuIdParams + '">';
                            input += headerMenu.ctgryNm+'</a>';
                            input += '</li>';
                        }
                        else {
                            input += '<li>';
                            input += '<a href="javascript:pageMove(\''+headerMenu.menuUrl+'\', \'\',\'\', \'' + makeMenuActiveIdenty(headerMenu.menuUrl, '') + '\');" id="headerMenuOrder' + makeMenuActiveIdenty(headerMenu.menuUrl, '') + '">';
                            input += headerMenu.ctgryNm+'</a>';
                            input += '</li>';
                        }

                    }
                }

                $("#headerNav ul").append(input);
    });
}
function insertAccnutNo(){
	let url = "/fo/Member/selectEntrpsAccntReg";
	pageMove(url,"","");
}
function onNewTab(url){
	let win = window.open(url);
    win.focus();
}

    </script>
</body>
</html>

